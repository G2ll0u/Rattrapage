{% extends "layout/base.twig" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="product-container">
    <div class="product-header">
        <h1>
            <i class="fas fa-shopping-cart"></i> Liste des Commandes
            {% if pendingCount > 0 %}
                <span class="badge badge-warning">{{ pendingCount }} commande(s) en attente</span>
            {% endif %}
        </h1>
        
        <div class="product-actions">
            <a href="{{ url('orders', 'create') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Nouvelle Commande
            </a>
            <a href="{{ url('orders', 'manage') }}" class="btn btn-info">
                <i class="fas fa-cog"></i> Gérer les Commandes
            </a>
        </div>
    </div>
    
    <div class="search-container">
    <div class="product-list-header">
        <h2><i class="fas fa-search"></i> Recherche</h2>
    </div>
    
    <form action="{{ url('orders', 'index') }}" method="GET" class="search-form">
        <div class="search-group">
            <label for="search"><i class="fas fa-search"></i> Recherche</label>
            <div class="search-field">
                <input type="text" id="search" name="search" class="form-control" placeholder="Rechercher une commande..." value="{{ search }}">
            </div>
        </div>
        
        <div class="search-group">
            <label for="status"><i class="fas fa-tag"></i> Statut</label>
            <div class="search-field">
                <select name="status" id="status" class="form-select" onchange="this.form.submit()">
                    <option value="">Tous statuts</option>
                    <option value="pending" {{ selectedStatus == 'pending' ? 'selected' : '' }}>En attente</option>
                    <option value="delivered" {{ selectedStatus == 'delivered' ? 'selected' : '' }}>Livrée</option>
                    <option value="cancelled" {{ selectedStatus == 'cancelled' ? 'selected' : '' }}>Annulée</option>
                </select>
            </div>
        </div>
        
        <div class="search-group">
            <label for="provider"><i class="fas fa-building"></i> Fournisseur</label>
            <div class="search-field">
                <select name="provider" id="provider" class="form-select" onchange="this.form.submit()">
                    <option value="">Tous fournisseurs</option>
                    {% for supplier in suppliers %}
                        <option value="{{ supplier.ID_Provider }}" {{ selectedProvider == supplier.ID_Provider ? 'selected' : '' }}>
                            {{ supplier.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="search-group">
            <label for="sort"><i class="fas fa-sort"></i> Trier par</label>
            <div class="search-field">
                <select name="sort" id="sort" class="form-select">
                    <option value="order_date" {{ sort == 'order_date' ? 'selected' : '' }}>Date de commande</option>
                    <option value="expected_date" {{ sort == 'expected_date' ? 'selected' : '' }}>Date de livraison</option>
                    <option value="status" {{ sort == 'status' ? 'selected' : '' }}>Statut</option>
                </select>
            </div>
        </div>
        
        <div class="search-group">
            <label for="direction"><i class="fas fa-sort-amount-down"></i> Ordre</label>
            <div class="search-field">
                <select name="direction" id="direction" class="form-select">
                    <option value="asc" {{ direction == 'asc' ? 'selected' : '' }}>Ascendant</option>
                    <option value="desc" {{ direction == 'desc' ? 'selected' : '' }}>Descendant</option>
                </select>
            </div>
        </div>
        
        <div class="search-buttons">
            <button type="submit" class="search-button">
                <i class="fas fa-search"></i> Rechercher
            </button>
            <a href="{{ url('orders', 'index') }}" class="search-reset">
                <i class="fas fa-redo"></i> Réinitialiser
            </a>
        </div>
    </form>
    
    <div class="category-filter">
        <a href="{{ url('orders', 'index') }}" class="category-pill {{ selectedStatus == '' ? 'active' : '' }}">
            Tous
        </a>
        <a href="{{ url('orders', 'index', {'status': 'pending'}) }}" class="category-pill {{ selectedStatus == 'pending' ? 'active' : '' }}">
            En attente
        </a>
        <a href="{{ url('orders', 'index', {'status': 'delivered'}) }}" class="category-pill {{ selectedStatus == 'delivered' ? 'active' : '' }}">
            Livrées
        </a>
        <a href="{{ url('orders', 'index', {'status': 'cancelled'}) }}" class="category-pill {{ selectedStatus == 'cancelled' ? 'active' : '' }}">
            Annulées
        </a>
    </div>
</div>
    
    <div class="product-grid">
        {% if orders|length > 0 %}
            {% for order in orders %}
                <div class="product-card">
                    <div class="product-stock-status {{ order.status == 'pending' ? 'low-stock' : (order.status == 'delivered' ? 'in-stock' : 'out-of-stock') }}">
                        {% if order.status == 'pending' %}
                            <i class="fas fa-exclamation-triangle"></i> En attente
                        {% elseif order.status == 'delivered' %}
                            <i class="fas fa-check-circle"></i> Livrée
                        {% else %}
                            <i class="fas fa-times-circle"></i> Annulée
                        {% endif %}
                    </div>
                    <div class="product-header">
                        <h3>Commande #{{ order.ID_Orders }}</h3>
                        <span class="product-ref">Fournisseur: {{ supplierNames[order.ID_Provider] }}</span>
                    </div>
                    <div class="product-info">
                        <div class="product-detail">
                            <span class="detail-label">Date commande:</span>
                            <span class="detail-value">{{ order.order_date|date("d/m/Y") }}</span>
                        </div>
                        <div class="product-detail">
                            <span class="detail-label">Livraison prévue:</span>
                            <span class="detail-value">{{ order.expected_date|date("d/m/Y") }}</span>
                        </div>
                        <div class="product-detail">
                            <span class="detail-label">Statut:</span>
                            <span class="detail-value">
                                {% if order.status == 'pending' %}
                                    En attente
                                {% elseif order.status == 'delivered' %}
                                    Livrée
                                {% else %}
                                    Annulée
                                {% endif %}
                            </span>
                        </div>
                        <div class="product-detail">
                            <span class="detail-label">Produits:</span>
                            <span class="detail-value">{{ order.lines|length ?? '0' }} produit(s)</span>
                        </div>
                    </div>
                    <div class="product-actions">
                    <a href="{{ url('orders', 'view', {'id': order.ID_Orders}) }}" class="btn btn-info btn-sm">
                        <i class="fas fa-eye"></i> Détails
                    </a>
                    {% if user.role == 'Manager' or user.role == 'Admin' %}
                    <a href="{{ url('orders', 'manage', {'action': 'edit', 'id': order.ID_Orders}) }}" class="btn btn-warning btn-sm">
                        <i class="fas fa-edit"></i> Modifier
                    </a>
                    {% endif %}
                    {% if user.role == 'Admin' %}
                    <a href="{{ url('orders', 'manage', {'action': 'delete', 'id': order.ID_Orders}) }}" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i> Supprimer
                    </a>
                    {% endif %}
                </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h3>Aucune commande trouvée</h3>
                <p>Essayez de modifier vos critères de recherche</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}